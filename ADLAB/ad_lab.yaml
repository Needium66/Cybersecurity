#BUILDING AN AD LAB, LLMNR POISONING AND NTLMv2 CRACKING W/ HASHCAT
#BUILD AN AD LAB
#AD EXPLOITATION: LLMNR POISONING

#BUILD AD LAB
https://www.microsoft.com/en-us/evalcenter/download-windows-server-2016
https://www.microsoft.com/en-us/evalcenter/download-windows-server-2022

Download it
#Evaluation for an 180days
Click on ISO for the "evaluation file type"
Click on "continue"
Enter your bio data
Click on "Continue"
It will automatically downlaod the ISO

#Do same for Windows 10 Enterprise
Select "ISO Enterprise" for the "evaluation file type"
Click on "Continue" and download it.

#Running 3 VMs at once for this lab
#you have to have a super fast computer

Once you set up the vm
Click on "Edit virtual machine settings" in the navigation pane on the left
select the "floppy" from the "Hardware options" (it causes a lot of issues)
Click on "Remove" button at the bottom
Click on "Power on this machine" in the navigation pane on the left
Hit enter to continue
Let it boot up
Hit "Next"
Hit "Install now"
Select "Standard evaluation desktop experience"Hit "Next"
Hit "Agree"
Hit "Next"

#How to set up domain controller(dc)
https://cloudinfrastructureservices.co.uk/setup-a-domain-controller-on-windows-server/

#dc/ad
From the "Server Manager" home page, select "Add roles and features"
Click "Next" on before you begin page
Click "Next" on "Select Installation Type" page- "Role based or feature based installation"
Select "destination server" from the pool and click on "Next"
Select "Server roles" "Active Directory Domain services"- check the box for it
Select "Add Features"
Click "Next"
Click "Next"
Click "Next"
Click "Install" (takes some minutes)
Once it shows "Installed", click on "Close"
#Need dc when we turn on ad service
Hit the top warning sign saying "promote this server to a domain controller"
From the deployment configuration, select "Add a new forest"
Give it a "Root domain name"
Click on "Next"
Leave all the default options as is and enter passwords for "Directory Service Restore Mode(DSRM) password"
Click on "Next"
Once the "NET Bios Domain name" is populated, click on "Next"
Click on "Next"
Click on "Next"
Click on "Install"
Once completed, restart the machine
Once completely booted, sign in again
Go to "Tools" at the top and select "Active Directory Users and Computers"
Expand the "forest" folder you created on the left
Select "Domain Controllers" to see what it is probably
There is "Users" folder, you can click on it to view too
Right click on the "Users"
Click "New"
Enter the details
Click "Next"
Set passwords
#So for any user(laptop or whatever), you will always be joining the domain

#All about enumeration and exploitation
Go to your "Server Manager"
Select "File Storage and Services"
Select "Shares" below "Servers"
Open up a new folder at the bottom
Go to "PC"
Go to C:drive
Right click and create a new folder and give it a name e.g hackme
Go back to the Server Manager and on the page where you have selected "Share", select "Task" dropdown button at the top
Select "New Share"
Select "SMB Share Quick" if it is not yet automatically selected
Enter the appropriate path to "Type a custom path" under "Select the server and path for this share" or "Browse"
Select the approrpiate folder e.g "hackme" folder in this case
Select "Next"
Select "Next"
Check the box for "Enable access based enumeration" and "Allow caching of share"
Select "Next"
Select "Next"
Select "OK"
Select "Next"
Select "Create"
Select "Close"
SMB Share has been created

#Go back to your machine and add the share
Click on "PC"
Click on "Files" at the top
Select "Map a network drive"
Give the drive a name in the "Folder" column e.g \\JIDE\hackme
Check the box for "Recoonect sign in"
Click "Finish"
You will have access to hackme folder

#LINK LOCAL MULTICAST NAME RESOLUTION/ NETBIOS NAME SERVICE (NBTMS)
#Used to identify host when DNS fails
#Downside: using username and hash
#ATTACK- Classic man in the middle attack
#targeting getting hashes from a network- some hashes that don't have specified destinations
#waiting to pounce as an hacker when an authenticated and authorized user sends his hash to you based on what you have configured.
#Hacker takes the hash and tries to run it against the password. If the password is not too long, you may have a field day.
#Or do a prelaying with the hash- try to send it to a server
#then use the hash to authenticate to a server via SMB without knowing the passwod of the server

#TODO
#Set up a man in the middle listener called responder
locate your responder on kali- locate Responder.py #should be in user share responder folder
cd into the path - cd /usr/share/responder/ #you are setting this up to get access to a particular server. maybe you have remote access
#already, by you are just sitting in there on the network and waiting to get an elevated access e.g through a misdirected hash
#best time to run this- in the morning, when people just resume at work at trying to access their workstations
run - python Responder.py -I eth0 -rdw # i for interface, switches of r,d and w
#It will show you the poisoners- LLMNR, NBT -NS, DNS/MONS
#The available servers- some maybe on, while others are off
#HTTP Options
#Poisoning options
#Generic Options

#We are listening to events and hash etc
#To trigger or check if it is working, try to connect to your lab pc and open the smb folder created(hackme)
#the responder will send something to the PC
#YOU CAN GRAB YOUR IP THROUGH ifconfig and open up a browser to run it there- it should trigger a hash for the responder that
#has been set up

#rockyou.txt /usr/share/wordlists/rockyou.txt.gz - locate it in that folder
#It is a file that has a massive password list. It is inbuil in kali by default
#unzip it from where it is located and use "hashcat" e.g run the below
hashcat -m 5600 hash.txt /root/rockyou.txt  #the m means mode, 5600 is the port we are using, /root/rockyou.txt path to where the wordlist is
#Output
                                                                             
┌──(kali㉿kali)-[~/Downloads]
└─$ locate rockyou.txt
/usr/share/wordlists/rockyou.txt.gz
                                                                             
┌──(kali㉿kali)-[~/Downloads]
└─$ 
#go to whatever machine you are running on and cd into the folder that has the hashcat file
#cd c:\Users\Olajide\Desktop\hashcat-4.2.1
#run "hashcat64.exe" -m 5600 hashes.txt rockyou.txt
#Once you run that, it will display a password that has been cracked on not. You can use this to navigate the network- have access
#realuniq is another wordlist that you can use.

#Defense Strategy
The best defense for this is to disable  LLMNR and NBT-NS
#To disable LLMNR
Select "Turn off multicast name resolution" under
Local computer policy
Computer configuration
Administratives template
networkDNS Client in the group policy editor

#To disable NBT-NS
Go to "Network Connections"
Network Adapter Properties
TCP/IPV4 Properties
Advanced Tab
WINS Tab
Select "Disable NETBIOS over TCP/IP"

#IF YOU CANNOT DISABLE LLMNR/NBT-NS, the best course of action is
1. Require Network Access Control. If an attacker cannot get onto the network, the attack cannot be performed
2. Require strong user passwords e.g > 12 characters in length and limit common usage. The more complex a password,the harder
it is for an attacker to crack the hash. Greater to crack anything more than 12.

#TODO- MS1710 FOR ETERNAL BLUE